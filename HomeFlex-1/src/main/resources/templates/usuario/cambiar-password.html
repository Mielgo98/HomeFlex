<!DOCTYPE html>
<html xmlns:th="http://www.thymeleaf.org">
  <head th:replace="fragments/head :: head('HomeFlex - Cambiar Contraseña')">
    <title>HomeFlex - Cambiar Contraseña</title>
  </head>
  <!-- Añadir Bootstrap Icons fuera del fragmento head para asegurar que se cargue -->
  <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.11.3/font/bootstrap-icons.min.css">
  
  <body>
    <header th:replace="fragments/header :: header"></header>
    
    <div class="container mt-5 mb-5">
      <div class="row">
        <!-- Menú lateral -->
        <div class="col-md-3 mb-4">
          <div class="card shadow">
            <div class="card-header bg-primary text-white">
              <h5 class="card-title mb-0">Mi cuenta</h5>
            </div>
            <div class="list-group list-group-flush">
              <a th:href="@{/perfil}" class="list-group-item list-group-item-action">
                <i class="bi bi-person-circle me-2"></i> Perfil
              </a>
              <a href="#" class="list-group-item list-group-item-action active">
                <i class="bi bi-key me-2"></i> Cambiar contraseña
              </a>
              <a th:href="@{/propiedades/mis-propiedades}" class="list-group-item list-group-item-action"
                 th:if="${#sets.contains(usuarioRoles.![nombre], 'PROPIETARIO')}">
                <i class="bi bi-house-door me-2"></i> Mis propiedades
              </a>
              <a th:href="@{/reservas/mis-reservas}" class="list-group-item list-group-item-action">
                <i class="bi bi-calendar-check me-2"></i> Mis reservas
              </a>
              <a th:href="@{/valoraciones/mis-valoraciones}" class="list-group-item list-group-item-action">
                <i class="bi bi-star me-2"></i> Mis valoraciones
              </a>
              <a th:href="@{/perfil/baja-usuario}" class="list-group-item list-group-item-action text-danger">
                <i class="bi bi-person-x me-2"></i> Dar de baja cuenta
              </a>
            </div>
          </div>
        </div>
        
        <!-- Contenido principal -->
        <div class="col-md-9">
          <div class="card shadow">
            <div class="card-header bg-primary text-white">
              <h5 class="card-title mb-0">Cambiar contraseña</h5>
            </div>
            <div class="card-body">
              <!-- Mensajes de alerta -->
              <div th:if="${mensajeExito}" class="alert alert-success alert-dismissible fade show" role="alert">
                <span th:text="${mensajeExito}"></span>
                <button type="button" class="btn-close" data-bs-dismiss="alert" aria-label="Close"></button>
              </div>
              <div th:if="${mensajeError}" class="alert alert-danger alert-dismissible fade show" role="alert">
                <span th:text="${mensajeError}"></span>
                <button type="button" class="btn-close" data-bs-dismiss="alert" aria-label="Close"></button>
              </div>
              
              <div class="row">
                <div class="col-lg-8 col-md-10 mx-auto">
                  <!-- Formulario para cambiar contraseña -->
                  <form id="cambiarPasswordForm" th:action="@{/perfil/cambiar-password}" th:object="${cambiarPasswordDTO}" method="post" novalidate>
                    <div class="mb-4">
                      <label for="passwordActual" class="form-label required-field">Contraseña actual</label>
                      <div class="input-group">
                        <input type="password" class="form-control" id="passwordActual" th:field="*{passwordActual}" required>
                        <button class="btn btn-outline-secondary toggle-password" type="button" data-target="passwordActual">
                          <i class="bi bi-eye"></i>
                        </button>
                      </div>
                      <div class="invalid-feedback" th:if="${#fields.hasErrors('passwordActual')}" th:errors="*{passwordActual}">
                        La contraseña actual es obligatoria
                      </div>
                    </div>
                    
                    <div class="mb-4">
                      <label for="passwordNueva" class="form-label required-field">Nueva contraseña</label>
                      <div class="input-group">
                        <input type="password" class="form-control" id="passwordNueva" th:field="*{passwordNueva}" required>
                        <button class="btn btn-outline-secondary toggle-password" type="button" data-target="passwordNueva">
                          <i class="bi bi-eye"></i>
                        </button>
                      </div>
                      <div class="invalid-feedback" th:if="${#fields.hasErrors('passwordNueva')}" th:errors="*{passwordNueva}">
                        La nueva contraseña debe cumplir los requisitos de seguridad
                      </div>
                      <div class="password-strength mt-2">
                        <div class="progress" style="height: 5px;">
                          <div id="password-strength-meter" class="progress-bar" role="progressbar" style="width: 0%;" aria-valuenow="0" aria-valuemin="0" aria-valuemax="100"></div>
                        </div>
                        <small id="password-strength-text" class="form-text text-muted">
                          La contraseña debe tener al menos 8 caracteres, una mayúscula, una minúscula, un número y un carácter especial
                        </small>
                      </div>
                    </div>
                    
                    <div class="mb-4">
                      <label for="confirmPassword" class="form-label required-field">Confirmar nueva contraseña</label>
                      <div class="input-group">
                        <input type="password" class="form-control" id="confirmPassword" th:field="*{confirmPassword}" required>
                        <button class="btn btn-outline-secondary toggle-password" type="button" data-target="confirmPassword">
                          <i class="bi bi-eye"></i>
                        </button>
                      </div>
                      <div class="invalid-feedback" th:if="${#fields.hasErrors('confirmPassword')}" th:errors="*{confirmPassword}">
                        Las contraseñas no coinciden
                      </div>
                    </div>
                    
                    <div class="alert alert-info mb-4">
                      <i class="bi bi-info-circle-fill me-2"></i>
                      Por seguridad, después de cambiar tu contraseña se cerrará tu sesión actual y deberás volver a iniciar sesión con la nueva contraseña.
                    </div>
                    
                    <div class="d-grid gap-2 d-md-flex justify-content-md-end">
                      <a th:href="@{/perfil}" class="btn btn-secondary me-md-2">
                        <i class="bi bi-x-circle me-2"></i>Cancelar
                      </a>
                      <button type="submit" class="btn btn-primary">
                        <i class="bi bi-check-circle me-2"></i>Cambiar contraseña
                      </button>
                    </div>
                  </form>
                </div>
              </div>
            </div>
          </div>
        </div>
      </div>
    </div>
    
    <footer th:replace="fragments/footer :: footer"></footer>
    
    <!-- Script para la funcionalidad de cambio de contraseña -->
    <script th:src="@{/js/cambiar-password.js}"></script>
  </body>
</html>