<!DOCTYPE html>
<html xmlns:th="http://www.thymeleaf.org" 
      xmlns:sec="http://www.thymeleaf.org/extras/spring-security">
<head>
  <meta charset="UTF-8">
  <title th:text="${propiedad.titulo} + ' - HomeFlex'">Detalle de Propiedad - HomeFlex</title>
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.5/dist/css/bootstrap.min.css" rel="stylesheet" integrity="sha384-SgOJa3DmI69IUzQ2PVdRZhwQ+dy64/BUtbMJw1MZ8t5HZApcHrRKUc4W0kG879m7" crossorigin="anonymous">
  <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.11.1/font/bootstrap-icons.css">
  <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" integrity="sha256-p4NxAoJBhIIN+hmNHrzRCf9tD/miZyoHS5obTRR9BMY=" crossorigin="" />
  <style>
    .carousel-item img {
      height: 500px;
      object-fit: cover;
    }
    #map {
      height: 300px;
      width: 100%;
      border-radius: 0.25rem;
    }
    .property-feature {
      display: flex;
      align-items: center;
      margin-bottom: 10px;
    }
    .feature-icon {
      font-size: 1.5rem;
      margin-right: 10px;
      color: #0d6efd;
    }
    .sticky-top {
      top: 20px;
    }
  </style>
</head>
<body>
  <!-- Navegación -->
  <nav class="navbar navbar-expand-lg navbar-dark bg-primary">
    <div class="container">
      <a class="navbar-brand" th:href="@{/}">HomeFlex</a>
      <button class="navbar-toggler" type="button" data-bs-toggle="collapse" data-bs-target="#navbarNav"
        aria-controls="navbarNav" aria-expanded="false" aria-label="Toggle navigation">
        <span class="navbar-toggler-icon"></span>
      </button>
      <div class="collapse navbar-collapse" id="navbarNav">
        <ul class="navbar-nav me-auto">
          <li class="nav-item">
            <a class="nav-link" th:href="@{/propiedades}">
              <i class="bi bi-house"></i> Propiedades
            </a>
          </li>
          <li class="nav-item">
            <a class="nav-link" th:href="@{/propiedades/buscar}">
              <i class="bi bi-search"></i> Buscar
            </a>
          </li>
        </ul>
        <ul class="navbar-nav">
          <li class="nav-item" sec:authorize="isAuthenticated()">
            <a class="nav-link" th:href="@{/propiedades/mis-propiedades}">
              <i class="bi bi-buildings"></i> Mis Propiedades
            </a>
          </li>
          <li class="nav-item" sec:authorize="isAuthenticated()">
            <a class="nav-link" th:href="@{/perfil}">
              <i class="bi bi-person-circle"></i> Mi Perfil
            </a>
          </li>
          <li class="nav-item" sec:authorize="isAuthenticated()">
            <form th:action="@{/logout}" method="post">
              <button type="submit" class="btn btn-link nav-link">
                <i class="bi bi-box-arrow-right"></i> Cerrar Sesión
              </button>
            </form>
          </li>
          <li class="nav-item" sec:authorize="!isAuthenticated()">
            <a class="nav-link" th:href="@{/login}">
              <i class="bi bi-box-arrow-in-right"></i> Iniciar Sesión
            </a>
          </li>
        </ul>
      </div>
    </div>
  </nav>

  <!-- Contenido principal -->
  <div class="container mt-4">
    <!-- Migas de pan -->
    <nav aria-label="breadcrumb" class="mb-4">
      <ol class="breadcrumb">
        <li class="breadcrumb-item"><a th:href="@{/}">Inicio</a></li>
        <li class="breadcrumb-item"><a th:href="@{/propiedades}">Propiedades</a></li>
        <li class="breadcrumb-item active" aria-current="page" th:text="${propiedad.titulo}">Detalle de Propiedad</li>
      </ol>
    </nav>

    <!-- Título de la propiedad -->
    <div class="row mb-4">
      <div class="col-md-8">
        <h1 th:text="${propiedad.titulo}">Título de la propiedad</h1>
        <p class="text-muted">
          <i class="bi bi-geo-alt-fill"></i> <span th:text="${propiedad.direccion + ', ' + propiedad.ciudad + ', ' + propiedad.pais}">Dirección, Ciudad, País</span>
        </p>
      </div>
      <div class="col-md-4 text-end" sec:authorize="isAuthenticated()" th:if="${#authentication.name == propiedad.propietario.username}">
        <a th:href="@{/propiedades/editar/{id}(id=${propiedad.id})}" class="btn btn-primary">
          <i class="bi bi-pencil-square"></i> Editar propiedad
        </a>
      </div>
    </div>

    <div class="row">
      <!-- Contenido principal -->
      <div class="col-md-8">
        <!-- Carrusel de imágenes -->
        <div id="propertyCarousel" class="carousel slide mb-4" data-bs-ride="carousel">
          <div class="carousel-inner">
            <div th:each="foto, iterStat : ${propiedad.fotos}" class="carousel-item" th:classappend="${iterStat.first} ? 'active' : ''">
              <img th:src="${foto.url}" class="d-block w-100" th:alt="${'Foto ' + iterStat.count + ' de ' + propiedad.titulo}">
            </div>
            <!-- Imagen por defecto si no hay fotos -->
            <div class="carousel-item active" th:if="${propiedad.fotos.isEmpty()}">
              <img src="/images/property-placeholder.jpg" class="d-block w-100" alt="Imagen no disponible">
            </div>
          </div>
          <button class="carousel-control-prev" type="button" data-bs-target="#propertyCarousel" data-bs-slide="prev" th:if="${propiedad.fotos.size() > 1}">
            <span class="carousel-control-prev-icon" aria-hidden="true"></span>
            <span class="visually-hidden">Anterior</span>
          </button>
          <button class="carousel-control-next" type="button" data-bs-target="#propertyCarousel" data-bs-slide="next" th:if="${propiedad.fotos.size() > 1}">
            <span class="carousel-control-next-icon" aria-hidden="true"></span>
            <span class="visually-hidden">Siguiente</span>
          </button>
        </div>

        <!-- Descripción y características -->
        <div class="card mb-4">
          <div class="card-body">
            <h4 class="card-title mb-3">Acerca de este alojamiento</h4>
            <p class="card-text" th:text="${propiedad.descripcion}">
              Descripción detallada de la propiedad...
            </p>
            
            <hr class="my-4">
            
            <h5 class="mb-3">Características</h5>
            <div class="row">
              <div class="col-md-6">
                <div class="property-feature">
                  <span class="feature-icon"><i class="bi bi-person-fill"></i></span>
                  <div>
                    <strong th:text="${propiedad.capacidad}">4</strong> huéspedes
                  </div>
                </div>
                <div class="property-feature">
                  <span class="feature-icon"><i class="bi bi-door-closed-fill"></i></span>
                  <div>
                    <strong th:text="${propiedad.dormitorios}">2</strong> dormitorios
                  </div>
                </div>
              </div>
              <div class="col-md-6">
                <div class="property-feature">
                  <span class="feature-icon"><i class="bi bi-droplet-fill"></i></span>
                  <div>
                    <strong th:text="${propiedad.banos}">1</strong> baños
                  </div>
                </div>
                <div class="property-feature">
                  <span class="feature-icon"><i class="bi bi-calendar-check"></i></span>
                  <div>
                    Disponible
                  </div>
                </div>
              </div>
            </div>
          </div>
        </div>

        <!-- Ubicación en el mapa -->
        <div class="card mb-4">
          <div class="card-body">
            <h4 class="card-title mb-3">Ubicación</h4>
            <div id="map"></div>
            <p class="mt-3 text-muted">
              <i class="bi bi-geo-alt-fill"></i> <span th:text="${propiedad.direccion + ', ' + propiedad.ciudad + ', ' + propiedad.pais}">Dirección completa</span>
            </p>
          </div>
        </div>

        <!-- Información del propietario -->
        <div class="card mb-4">
          <div class="card-body">
            <h4 class="card-title mb-3">Acerca del anfitrión</h4>
            <div class="d-flex align-items-center">
              <img th:src="${propiedad.propietario.fotoPerfil != null ? propiedad.propietario.fotoPerfil : '/images/default-avatar.png'}" 
                   alt="Foto de perfil" class="rounded-circle me-3" style="width: 60px; height: 60px; object-fit: cover;">
              <div>
                <h5 class="mb-1" th:text="${propiedad.propietario.nombre + ' ' + propiedad.propietario.apellidos}">Nombre del propietario</h5>
                <p class="text-muted mb-0">
                  <i class="bi bi-calendar"></i> Miembro desde <span th:text="${#temporals.format(propiedad.propietario.fechaRegistro, 'MMMM yyyy')}">Enero 2025</span>
                </p>
              </div>
            </div>
            
            <hr class="my-3">
            
            <div sec:authorize="isAuthenticated()" th:if="${#authentication.name != propiedad.propietario.username}">
              <a href="#" class="btn btn-outline-primary">
                <i class="bi bi-chat-dots"></i> Contactar con el anfitrión
              </a>
            </div>
          </div>
        </div>
      </div>

      <!-- Barra lateral -->
      <div class="col-md-4">
        <div class="card sticky-top">
          <div class="card-body">
            <h3 class="card-title">
              <span th:text="${'€' + #numbers.formatDecimal(propiedad.precioDia, 0, 'POINT', 2, 'COMMA')}">€50,00</span>
              <small class="text-muted">/ noche</small>
            </h3>
            
            <hr>
            
            <!-- Precio semanal si está disponible -->
            <p th:if="${propiedad.precioSemana != null}" class="text-muted mb-4">
              <i class="bi bi-calendar-week"></i> Precio semanal: 
              <strong th:text="${'€' + #numbers.formatDecimal(propiedad.precioSemana, 0, 'POINT', 2, 'COMMA')}">€300,00</strong>
            </p>
            
            <!-- Formulario de reserva -->
            <form th:action="@{/reservas/solicitar}" method="post" sec:authorize="isAuthenticated()" th:if="${#authentication.name != propiedad.propietario.username}">
              <input type="hidden" name="propiedadId" th:value="${propiedad.id}">
              
              <div class="mb-3">
                <label for="fechaInicio" class="form-label">Fecha de llegada</label>
                <input type="date" class="form-control" id="fechaInicio" name="fechaInicio" required>
              </div>
              
              <div class="mb-3">
                <label for="fechaFin" class="form-label">Fecha de salida</label>
                <input type="date" class="form-control" id="fechaFin" name="fechaFin" required>
              </div>
              
              <div class="mb-3">
                <label for="numHuespedes" class="form-label">Número de huéspedes</label>
                <select class="form-select" id="numHuespedes" name="numHuespedes" required>
                  <option value="" selected disabled>Selecciona...</option>
                  <option th:each="i : ${#numbers.sequence(1, propiedad.capacidad)}" th:value="${i}" th:text="${i}">1</option>
                </select>
              </div>
              
              <div class="d-grid gap-2">
                <button type="submit" class="btn btn-primary">
                  <i class="bi bi-calendar-check"></i> Solicitar reserva
                </button>
              </div>
            </form>
            
            <!-- Mensaje para iniciar sesión -->
            <div class="alert alert-info" sec:authorize="!isAuthenticated()">
              <i class="bi bi-info-circle-fill"></i> Para realizar una reserva, debes <a th:href="@{/login}">iniciar sesión</a>.
            </div>
            
            <!-- Mensaje para propietario -->
            <div class="alert alert-info" sec:authorize="isAuthenticated()" th:if="${#authentication.name == propiedad.propietario.username}">
              <i class="bi bi-info-circle-fill"></i> Esta es tu propiedad, no puedes reservarla.
            </div>
          </div>
        </div>
      </div>
    </div>
  </div>

  <!-- Footer -->
  <footer class="footer mt-5 py-3 bg-light">
    <div class="container text-center">
      <span class="text-muted">© 2025 HomeFlex - Todos los derechos reservados</span>
    </div>
  </footer>

  <!-- Scripts -->
  <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.5/dist/js/bootstrap.bundle.min.js" integrity="sha384-k6d4wzSIapyDyv1kpU366/PK5hCdSbCRGRCMv+eplOQJWyd1fbcAu9OCUj5zNLiq" crossorigin="anonymous"></script>
  <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js" integrity="sha256-20nQCchB9co0qIjJZRGuk2/Z9VM+kNiyxNV1lvTlZBo=" crossorigin=""></script>
  
  <script th:inline="javascript">
    document.addEventListener('DOMContentLoaded', function() {
      // Inicializar el mapa con las coordenadas de la propiedad
      const lat = [[${propiedad.latitud}]];
      const lng = [[${propiedad.longitud}]];
      
      if (lat && lng) {
        const map = L.map('map').setView([lat, lng], 15);
        
        L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
          attribution: '&copy; <a href="https://www.openstreetmap.org/copyright">OpenStreetMap</a> contributors'
        }).addTo(map);
        
        // Añadir marcador
        L.marker([lat, lng]).addTo(map)
          .bindPopup([[${propiedad.titulo}]])
          .openPopup();
      } else {
        // Si no hay coordenadas, mostrar la ubicación aproximada por ciudad
        const direccion = [[${propiedad.ciudad + ', ' + propiedad.pais}]];
        
        // Inicializar mapa con centro en España
        const map = L.map('map').setView([40.416775, -3.703790], 5);
        
        L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
          attribution: '&copy; <a href="https://www.openstreetmap.org/copyright">OpenStreetMap</a> contributors'
        }).addTo(map);
        
        // Intentar geocodificar la dirección
        fetch(`https://nominatim.openstreetmap.org/search?format=json&q=${encodeURIComponent(direccion)}`)
          .then(response => response.json())
          .then(data => {
            if (data && data.length > 0) {
              const lat = parseFloat(data[0].lat);
              const lng = parseFloat(data[0].lon);
              map.setView([lat, lng], 12);
              L.marker([lat, lng]).addTo(map)
                .bindPopup([[${propiedad.titulo}]])
                .openPopup();
            }
          })
          .catch(error => console.error('Error al geocodificar la dirección:', error));
      }
      
      // Validación de fechas de reserva
      const fechaInicio = document.getElementById('fechaInicio');
      const fechaFin = document.getElementById('fechaFin');
      
      if (fechaInicio && fechaFin) {
        // Establecer fecha mínima como hoy
        const hoy = new Date();
        const fechaHoy = hoy.toISOString().split('T')[0];
        fechaInicio.min = fechaHoy;
        
        // Actualizar fecha mínima de salida cuando cambia la fecha de entrada
        fechaInicio.addEventListener('change', function() {
          if (fechaInicio.value) {
            // La fecha de salida debe ser al menos un día después de la fecha de entrada
            const fechaEntrada = new Date(fechaInicio.value);
            fechaEntrada.setDate(fechaEntrada.getDate() + 1);
            fechaFin.min = fechaEntrada.toISOString().split('T')[0];
            
            // Si la fecha de salida es anterior a la nueva fecha mínima, actualizarla
            if (fechaFin.value && new Date(fechaFin.value) < fechaEntrada) {
              fechaFin.value = fechaEntrada.toISOString().split('T')[0];
            }
          }
        });
      }
    });
  </script>
</body>
</html>